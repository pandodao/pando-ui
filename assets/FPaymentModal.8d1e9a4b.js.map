{"version":3,"file":"FPaymentModal.8d1e9a4b.js","sources":["../../packages/uikit/src/components/FPaymentModal/FPaymentModal.tsx"],"sourcesContent":["import { defineComponent, ref, watch } from \"vue\";\nimport { useDisplay, useLocale } from \"vuetify\";\nimport { isMixin } from \"@foxone/utils/mixin\";\n\nimport type { PaymentOptions } from \"../../plugins/payment\";\n\nimport { FModal } from \"../FModal\";\nimport { FPayingModal } from \"../FPayingModal\";\nimport { FQRCode } from \"../FQRCode\";\nimport { FButton } from \"../FButton\";\nimport { VImg } from \"vuetify/components\";\n\nimport \"./FPaymentModal.scss\";\n\nexport const FPaymentModal = defineComponent({\n  name: \"FPaymentModal\",\n\n  inheritAttrs: false,\n\n  emits: {\n    destroy: () => true,\n  },\n\n  setup(_, { expose, emit }) {\n    const dialog = ref(false);\n    const asset = ref<any>(null);\n    const checking = ref(false);\n    const timer = ref<any>(null);\n    const reject = ref<any>(null);\n    const qr = ref(false);\n\n    // Payment Options\n    const assetId = ref(\"\");\n    const amount = ref(\"\");\n    const scheme = ref(\"\");\n    const channel = ref(\"\");\n    const hideCheckingModal = ref(false);\n\n    const { mdAndUp } = useDisplay();\n    const { t } = useLocale();\n\n    const cancel = () => {\n      checking.value = false;\n    };\n\n    const handlePaid = () => {\n      checking.value = true;\n    };\n\n    const handleOpenInApp = () => {\n      window.location.href = scheme.value;\n    };\n\n    const handleModalChange = (value) => {\n      if (!value) {\n        if (reject.value && typeof reject.value === \"function\") {\n          reject.value(new Error(\"Cancelled\"));\n        }\n\n        timer.value && clearTimeout(timer.value);\n        checking.value = false;\n        channel.value = \"\";\n        scheme.value = \"\";\n        qr.value = false;\n        asset.value = null;\n        reject.value = null;\n      }\n\n      if (!dialog.value) {\n        emit(\"destroy\");\n      }\n    };\n\n    watch(() => checking.value, handleModalChange);\n    watch(() => dialog.value, handleModalChange);\n\n    const show = async (options: PaymentOptions) => {\n      const { actions, checker } = options;\n\n      scheme.value = options.scheme;\n      channel.value = options.channel;\n      assetId.value = options.assetId;\n      amount.value = options.amount;\n      hideCheckingModal.value = options.hideCheckingModal || false;\n\n      const showChecking = () => (checking.value = true);\n\n      switch (channel.value) {\n        case \"mixin\":\n          if (isMixin()) {\n            actions.mixin?.();\n            showChecking();\n          } else {\n            dialog.value = true;\n            qr.value = true;\n            requestAsset();\n          }\n          break;\n        case \"fennec\":\n          await actions.fennec?.();\n          showChecking();\n          break;\n        default:\n          await actions.mvm?.();\n          showChecking();\n          break;\n      }\n\n      return new Promise((resolve, _reject) => {\n        reject.value = _reject;\n        polling(resolve, _reject, checker);\n      });\n    };\n\n    const requestAsset = async () => {\n      const response = await fetch(\n        `https://api.mixin.one/network/assets/${assetId.value}`\n      );\n\n      asset.value = (await response.json()).data;\n    };\n\n    const polling = async (resolve, reject, checker) => {\n      try {\n        const completed = await checker();\n\n        if (!completed) {\n          timer.value = setTimeout(() => {\n            if (dialog.value || checking.value) {\n              polling(resolve, reject, checker);\n            }\n          }, 3000);\n        } else {\n          dialog.value = false;\n          checking.value = false;\n          resolve();\n        }\n      } catch (error) {\n        reject(error);\n        dialog.value = false;\n        checking.value = false;\n      }\n    };\n\n    expose({ show });\n\n    return () => (\n      <div>\n        <FModal v-model={dialog.value} maxWidth=\"780\">\n          <div\n            class={`f-payment-modal__content ${\n              !mdAndUp.value && \"f-payment-modal__content--mobile\"\n            }`}\n          >\n            <div class=\"f-payment-modal__left\">\n              {scheme.value && (\n                <FQRCode\n                  class=\"f-payment-modal__qr\"\n                  text={scheme.value}\n                  size={182}\n                />\n              )}\n            </div>\n\n            <div class=\"f-payment-modal__right\">\n              {asset.value && (\n                <>\n                  <div class=\"f-payment-modal__logo\">\n                    <VImg\n                      src={asset.value?.icon_url ?? \"\"}\n                      width={32}\n                      height={32}\n                    />\n                  </div>\n                  <div class=\"f-payment-modal__amount mt-1\">\n                    <div>{t(\"$vuetify.uikit.scan_to_pay\")}</div>\n                    <div>{amount.value + \" \" + asset.value?.symbol ?? \"\"}</div>\n                  </div>\n                </>\n              )}\n              <div\n                class=\"f-payment-modal__hint mt-5\"\n                innerHTML={t(\"$vuetify.uikit.mixin_pay_detail\", [\n                  \"<a class='f-auth-mixin__link' href='https://mixin.one/messenger'>Mixin Messenger\" +\n                    \"<svg width='14' height='14' viewBox='0 0 14 14' fill='none' xmlns='http://www.w3.org/2000/svg'>\" +\n                    \"<path d='M12.2068 1.79276C10.2975 -0.116585 7.2018 -0.116585 5.29246 1.79276L4.64288 2.44234C4.25236 2.83286 4.25236 3.46603 4.64288 3.85655C5.03341 4.24707 5.66657 4.24707 6.0571 3.85655L6.70667 3.20698C7.83497 2.07868 9.6643 2.07868 10.7926 3.20698C11.9209 4.33528 11.9209 6.16461 10.7926 7.29291L10.1425 7.94304C9.75195 8.33357 9.75194 8.96673 10.1425 9.35726C10.533 9.74778 11.1662 9.74778 11.5567 9.35726L12.2068 8.70712C14.1162 6.79778 14.1162 3.70211 12.2068 1.79276Z' fill='#076aff'/>\" +\n                    \"<path d='M3.85726 6.05638C4.24779 5.66586 4.24779 5.03269 3.85726 4.64217C3.46674 4.25165 2.83357 4.25165 2.44305 4.64217L1.79236 5.29286C-0.116985 7.2022 -0.116985 10.2979 1.79236 12.2072C3.70171 14.1166 6.79738 14.1166 8.70672 12.2072L9.35713 11.5568C9.74765 11.1663 9.74765 10.5331 9.35713 10.1426C8.9666 9.75207 8.33344 9.75207 7.94291 10.1426L7.29251 10.793C6.16421 11.9213 4.33488 11.9213 3.20658 10.793C2.07828 9.6647 2.07828 7.83537 3.20658 6.70707L3.85726 6.05638Z' fill='#076aff'/>\" +\n                    \"<path d='M8.20674 7.2071C8.59727 6.81658 8.59727 6.18341 8.20674 5.79289C7.81622 5.40237 7.18305 5.40237 6.79253 5.79289L5.73187 6.85355C5.34134 7.24408 5.34134 7.87724 5.73187 8.26776C6.12239 8.65829 6.75556 8.65829 7.14608 8.26776L8.20674 7.2071Z' fill='#076aff'/>\" +\n                    \"</svg>\" +\n                    \"</a>\",\n                ])}\n              ></div>\n              <div class=\"f-payment-modal__actions\">\n                <FButton\n                  loading={checking.value}\n                  color=\"greyscale_1\"\n                  onClick={handlePaid}\n                >\n                  {t(\"$vuetify.uikit.paid\")}\n                </FButton>\n                <FButton color=\"greyscale_6\" onClick={handleOpenInApp}>\n                  {t(\"$vuetify.uikit.open_in_mixin\")}\n                </FButton>\n              </div>\n            </div>\n          </div>\n        </FModal>\n\n        <FPayingModal\n          modelValue={!qr.value && !hideCheckingModal.value && checking.value}\n          onCancel={cancel}\n        />\n      </div>\n    );\n  },\n});\n"],"names":["_isSlot","s","Object","prototype","toString","call","_isVNode","FPaymentModal","defineComponent","name","inheritAttrs","emits","destroy","setup","_","expose","emit","dialog","ref","asset","checking","timer","reject","qr","assetId","amount","scheme","channel","hideCheckingModal","mdAndUp","useDisplay","t","useLocale","cancel","value","handlePaid","handleOpenInApp","window","location","href","handleModalChange","Error","clearTimeout","watch","show","__name","options","actions","checker","showChecking","isMixin","mixin","requestAsset","fennec","mvm","Promise","resolve","_reject","polling","response","fetch","json","data","setTimeout","error","_slot","_slot2","_createVNode","FModal","$event","default","FQRCode","_Fragment","VImg","icon_url","symbol","FButton","FPayingModal"],"mappings":"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"}