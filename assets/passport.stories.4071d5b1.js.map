{"version":3,"file":"passport.stories.4071d5b1.js","sources":["../../packages/passport/stories/Passport.tsx"],"sourcesContent":["/* eslint-disable vue/one-component-per-file */\nimport \"./Passport.scss\";\n\nimport { computed, defineComponent, onMounted, ref, watch } from \"vue\";\nimport { VAvatar, VIcon, VImg, VSheet } from \"vuetify/components\";\nimport { FButton, FFiatDivision, FListItem } from \"@foxone/uikit/components\";\nimport { useToast } from \"@foxone/uikit/plugins/toast\";\nimport { usePassport } from \"@foxone/mixin-passport/lib/helper\";\nimport { v4 as uuid } from \"uuid\";\n\nexport const Passport = defineComponent({\n  name: \"Passport\",\n\n  props: {\n    authOptions: { type: Object },\n    paymentOptions: { type: Object },\n  },\n\n  setup(props) {\n    const token = ref(\"\");\n    const channel = ref(\"\");\n    const profile = ref<any>(null);\n    const assets = ref<any>([]);\n    const passport = usePassport();\n    const toast = useToast();\n    const loading = ref(false);\n\n    const connected = computed(() => Boolean(token.value && channel.value));\n\n    async function handleConnect() {\n      try {\n        const data = await passport.auth(props.authOptions as any);\n\n        token.value = data.token;\n        channel.value = data.channel;\n\n        localStorage.setItem(\"token\", data.token);\n        localStorage.setItem(\"channel\", data.channel);\n      } catch (error) {\n        console.log(error);\n      }\n    }\n\n    async function handleDisconnect() {\n      token.value = \"\";\n      channel.value = \"\";\n\n      localStorage.setItem(\"token\", \"\");\n      localStorage.setItem(\"channel\", \"\");\n    }\n\n    async function handlePayment() {\n      const traceId = uuid();\n      const options = {\n        ...props.paymentOptions,\n        traceId,\n        checker: async () => {\n          const resp = await fetch(\n            \"https://api.mixin.one/transfers/trace/\" + traceId,\n            {\n              method: \"GET\",\n              headers: {\n                Authorization: `Bearer ${token.value}`,\n              },\n            }\n          );\n          const json = await resp.json();\n\n          if (json.data) {\n            toast.success({ message: \"Payment checked\" });\n\n            return true;\n          } else {\n            return false;\n          }\n        },\n      };\n\n      passport.payment(options);\n    }\n\n    watch(\n      () => token.value,\n      async () => {\n        profile.value = await passport.getProfile();\n        assets.value = await passport.getAssets();\n      }\n    );\n\n    onMounted(async () => {\n      try {\n        loading.value = true;\n\n        const localeToken = localStorage.getItem(\"token\") || \"\";\n        const localeChannel = localStorage.getItem(\"channel\") || \"\";\n\n        const data = await passport.sync({\n          origin: \"FoxONE UIKit\",\n          token: localeToken,\n          channel: localeChannel as any,\n          refreshToken: true,\n        });\n\n        console.log(\"after sync\");\n\n        token.value = data.token;\n        channel.value = data.channel;\n\n        loading.value = false;\n      } catch (error) {\n        console.log(error);\n      }\n    });\n\n    return () => (\n      <div class=\"passport-overvie-container\">\n        {loading.value || (\n          <div class=\"passport-overview\">\n            {connected.value ? (\n              <Connected\n                profile={profile.value}\n                assets={assets.value}\n                onDisconnect={() => handleDisconnect()}\n                onPayment={() => handlePayment()}\n              />\n            ) : (\n              <Disconnected onConnect={() => handleConnect()} />\n            )}\n          </div>\n        )}\n      </div>\n    );\n  },\n});\n\nconst Disconnected = defineComponent({\n  name: \"Disconnected2\",\n\n  emits: {\n    connect: () => true,\n  },\n\n  setup(props, { emit }) {\n    return () => (\n      <div class=\"passport-account-disconnected\">\n        <VIcon>$FIconWalletAFill</VIcon>\n\n        <div class=\"disconnected--hint\">Please connect your wallet first</div>\n\n        <FButton color=\"primary\" onClick={() => emit(\"connect\")}>\n          Connect Wallet\n        </FButton>\n      </div>\n    );\n  },\n});\n\nconst Connected = defineComponent({\n  name: \"Connected\",\n\n  props: {\n    profile: Object,\n    assets: Array,\n  },\n\n  emits: {\n    disconnect: () => true,\n    payment: () => true,\n  },\n\n  setup(props, { emit }) {\n    const name = computed(() => props.profile?.full_name);\n    const avatar = computed(() => props.profile?.avatar_url);\n    const balance = computed(() => {\n      const amount =\n        props.assets?.reduce(\n          (total: number, asset: any) =>\n            total + asset.balance * asset.price_usd,\n          0\n        ) ?? 0;\n\n      return new Intl.NumberFormat(\"en\", {\n        currency: \"USD\",\n        style: \"currency\",\n      }).formatToParts(amount);\n    });\n\n    return () => (\n      <div class=\"passport-account-connected\">\n        <VAvatar size=\"48\">\n          <VImg src={avatar.value} />\n        </VAvatar>\n\n        <div class=\"user-name mt-2\">\n          <span>{name.value}</span>\n        </div>\n\n        <VSheet theme=\"dark\" class=\"account-balance my-9\">\n          <div class=\"account-label mb-4\">Wallet Assets</div>\n\n          <FFiatDivision parts={balance.value} />\n        </VSheet>\n\n        <FListItem\n          height=\"56\"\n          title=\"Disconnect\"\n          prependIcon=\"$FIconDisconnect\"\n          class=\"text-error px-0\"\n          onClick={() => emit(\"disconnect\")}\n        />\n        <FListItem\n          height=\"56\"\n          title=\"Payment\"\n          prependIcon=\"$FIconBorrow\"\n          class=\"px-0\"\n          onClick={() => emit(\"payment\")}\n        />\n      </div>\n    );\n  },\n});\n"],"names":["Passport","defineComponent","name","props","authOptions","type","Object","paymentOptions","setup","token","ref","channel","profile","assets","passport","usePassport","toast","useToast","loading","connected","computed","Boolean","value","handleConnect","data","auth","localStorage","setItem","error","console","log","handleDisconnect","handlePayment","traceId","uuid","options","checker","fetch","method","headers","Authorization","json","success","message","payment","watch","getProfile","getAssets","onMounted","localeToken","getItem","localeChannel","sync","origin","refreshToken","_createVNode","Connected","Disconnected","emits","connect","emit","VIcon","_createTextVNode","FButton","Array","disconnect","full_name","avatar","avatar_url","balance","amount","reduce","total","asset","price_usd","Intl","NumberFormat","currency","style","formatToParts","VAvatar","VImg","VSheet","FFiatDivision","FListItem"],"mappings":"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"}